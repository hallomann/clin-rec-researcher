<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ClinRecResearcher — Поиск клинических рекомендаций</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            .result-card {
                margin-bottom: 1rem;
            }
            .mkb-option {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        </style>
    </head>
    <body class="bg-light">
        <div class="container py-4">
            <h2 class="mb-4">Поиск клинических рекомендаций по МКБ-10</h2>

            <div class="row mb-4">
                <div class="col-md-8">
                    <select id="mkbSelect" class="form-select" required>
                        <option value="">— Выберите код МКБ-10 —</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button id="searchBtn" class="btn btn-primary w-100">
                        Найти
                    </button>
                </div>
            </div>

            <div id="results" class="mt-4"></div>
        </div>

        <script>
            let records = [];

            // Загружаем данные из data.json
            fetch("data.json")
                .then((res) => res.json())
                .then((data) => {
                    records = data;
                    const select = document.getElementById("mkbSelect");
                    const uniqueMKB = [
                        ...new Set(data.map((r) => r["МКБ-10"])),
                    ].sort();
                    uniqueMKB.forEach((mkb) => {
                        const opt = document.createElement("option");
                        opt.value = mkb;
                        opt.textContent = mkb;
                        opt.className = "mkb-option";
                        select.appendChild(opt);
                    });
                })
                .catch((err) => {
                    document.getElementById("results").innerHTML =
                        '<div class="alert alert-danger">Ошибка загрузки данных: ' +
                        err +
                        "</div>";
                });

            document
                .getElementById("searchBtn")
                .addEventListener("click", () => {
                    const code = document.getElementById("mkbSelect").value;
                    const resultsDiv = document.getElementById("results");

                    if (!code) {
                        resultsDiv.innerHTML =
                            '<div class="alert alert-warning">Выберите код МКБ-10</div>';
                        return;
                    }

                    const matches = records.filter((r) => r["МКБ-10"] === code);
                    if (matches.length === 0) {
                        resultsDiv.innerHTML =
                            '<div class="alert alert-warning">Ничего не найдено</div>';
                        return;
                    }

                    let html = `<h3>Результаты по запросу: <em>${code}</em></h3>`;
                    html += '<div class="row">';
                    matches.forEach((rec) => {
                        html += `
                            <div class="col-md-6 mb-3">
                                <div class="card result-card">
                                <div class="card-body">
                                    <h6 class="card-title">${rec.Имя}</h6>
                                    <small class="text-muted">${rec["МКБ-10"]}</small><br>
                                    <a href="${rec.link}" target="_blank" class="btn btn-outline-primary btn-sm mt-2">Открыть рекомендацию</a>
                                </div>
                                </div>
                            </div>`;
                        });
                    html += "</div>";
                    resultsDiv.innerHTML = html;
                });
        </script>
    </body>
</html>
